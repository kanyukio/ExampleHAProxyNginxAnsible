# Пример проекта, объединяющего использование HAProxy, Nginx и Ansible для создания высокодоступной веб-инфраструктуры

## Цель проекта

### Развертывание высокодоступной веб-инфраструктуры с балансировкой нагрузки с помощью HAProxy, обратным прокси через Nginx и автоматизацией конфигурации с использованием Ansible

### Шаги проекта

1. Подготовка инфраструктуры:
   - Разверните несколько виртуальных или физических серверов, которые будут выступать в роли веб-серверов и балансировщика нагрузки.
   - Установите операционную систему на каждом сервере.

    Начнем с первого шага "Подготовка инфраструктуры". В этом шаге вы развернете несколько серверов и установите на них операционную систему. Процесс может различаться в зависимости от ваших предпочтений и инструментов, которые вы используете, но вот общие шаги:

    **1.1. Выбор инфраструктуры:** Решите, будут ли это виртуальные или физические серверы. Если вы используете виртуализацию, например, VMware или VirtualBox, создайте несколько виртуальных машин.

    **1.2. Выбор операционной системы:** Выберите операционную систему для серверов. Это может быть Linux-дистрибутив, такой как Ubuntu, CentOS или Debian. Убедитесь, что выбранная ОС подходит для работы с HAProxy, Nginx и Ansible.

    **1.3. Установка операционной системы:** Загрузите образ операционной системы и выполните установку на каждом сервере. Следуйте инструкциям на экране, чтобы настроить настройки, такие как сетевое подключение, имя хоста и пароли.

    **1.4. Обновление и настройка:**: После установки ОС, выполните обновление системы и установите базовые пакеты. Это обычно включает в себя команды типа:

    ```
    sudo apt update
    sudo apt upgrade
    ```

    **1.5. Настройка сети:** Настройте статический IP-адрес и другие сетевые параметры для каждого сервера. Это важно для обеспечения стабильной связи между серверами.

    **1.6. Настройка SSH:** Убедитесь, что SSH доступ настроен на каждом сервере. Это позволит вам подключаться к серверам и управлять ими удаленно.

    **1.7. Создание пользователей:** Создайте учетные записи пользователей с необходимыми правами доступа. В будущем, при использовании Ansible, вам понадобится пользователь с правами sudo.

    **1.8. Файрволлы:** Если используется, настройте брандмауэр для разрешения необходимых сетевых соединений.

    **1.9. Подготовка DNS:** Если у вас есть доменное имя, настройте DNS-записи, чтобы ваши серверы были доступны по имени.

    После завершения этого шага, у вас будет готовая инфраструктура для дальнейшего развертывания и настройки HAProxy, Nginx и Ansible.

2. HAProxy:
   - Установите и настройте HAProxy на отдельном сервере для балансировки нагрузки между веб-серверами.
   - Настройте HAProxy для обработки HTTPS-запросов с помощью SSL-терминации.

   Отлично, перейдем ко второму шагу "HAProxy". Здесь мы установим и настроим HAProxy для балансировки нагрузки и обработки HTTPS-запросов. Процесс может немного отличаться в зависимости от используемой операционной системы, но вот общие шаги:

    2.1. **Установка HAProxy:**
    - На сервере, который будет выступать в роли балансировщика нагрузки, выполните установку HAProxy. Для большинства дистрибутивов Linux это можно сделать с помощью команды:

     ```
     sudo apt install haproxy
     ```

    2.2. **Настройка HAProxy:**
    - Отредактируйте конфигурационный файл HAProxy, обычно он находится в `/etc/haproxy/haproxy.cfg`. Пример настройки для балансировки нагрузки на веб-серверы:

     ```ini
     frontend http-in
         bind *:80
         mode http
         default_backend servers

     backend servers
         balance roundrobin
         server server1 <IP-адрес1>:<порт1> check
         server server2 <IP-адрес2>:<порт2> check
     ```

    2.3. **SSL-терминация:**
    - Для обработки HTTPS-запросов настройте HAProxy для SSL-терминации. Добавьте соответствующие строки в конфигурацию:

     ```ini
     frontend https-in
         bind *:443 ssl crt /etc/haproxy/certs/
         mode http
         default_backend servers
     ```

    2.4. **Получение SSL-сертификата:**
    - Получите SSL-сертификат для вашего домена от надежного провайдера, такого как Let's Encrypt.
    - Сохраните сертификат и закрытый ключ на сервере HAProxy.

    2.5. **Обновление брандмауэра:**
    - Убедитесь, что брандмауэр разрешает трафик на порты 80 и 443, чтобы HAProxy мог обслуживать HTTP и HTTPS.

    2.6. **Перезапуск HAProxy:**
    - После внесения изменений в конфигурацию, перезапустите HAProxy для применения изменений:

     ```
     sudo service haproxy restart
     ```

    После выполнения этих шагов, ваш HAProxy должен быть настроен для балансировки нагрузки между веб-серверами и обработки HTTPS-запросов с использованием SSL-терминации.

3. Nginx:
   - Установите и настройте Nginx на каждом веб-сервере.
   - Конфигурируйте Nginx как обратный прокси для взаимодействия с вашими веб-приложениями.

   Продолжим с третьим шагом "Nginx". Здесь мы установим и настроим Nginx на каждом веб-сервере, а также настроим его в качестве обратного прокси для взаимодействия с веб-приложениями. Вот как это можно сделать:

    3.1. **Установка Nginx:**
    - На каждом веб-сервере, куда вы хотите установить Nginx, выполните установку. Для большинства дистрибутивов Linux это можно сделать с помощью команды:

     ```
     sudo apt install nginx
     ```

    3.2. **Настройка Nginx как обратного прокси:**
    - Отредактируйте файл конфигурации Nginx. Обычно он находится в `/etc/nginx/sites-available/default`.
    - Добавьте секцию `location` для настройки обратного прокси:

     ```nginx
     server {
         listen 80;
         server_name your_domain.com;

         location / {
             proxy_pass http://backend_servers;
             proxy_set_header Host $host;
             proxy_set_header X-Real-IP $remote_addr;
             proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
         }
     }
     ```

    3.3. **Настройка "backend_servers":**
    - В вашей конфигурации Nginx, внутри блока `http`, добавьте блок `upstream`, определяющий вашу балансировку нагрузки. Например:

     ```nginx
     http {
         upstream backend_servers {
             server <IP-адрес1>:<порт1>;
             server <IP-адрес2>:<порт2>;
         }
         # ...
     }
     ```

    3.4. **Проверка и перезапуск Nginx:**
    - Проверьте конфигурацию Nginx на наличие ошибок:

     ```
     sudo nginx -t
     ```

   - Если конфигурация в порядке, перезапустите Nginx для применения изменений:

     ```
     sudo service nginx restart
     ```

    После выполнения этих шагов, Nginx будет настроен как обратный прокси, перенаправляющий запросы к веб-приложениям через HAProxy, что обеспечит эффективное взаимодействие между веб-серверами и балансировщиком нагрузки.

4. Ansible:
   - Напишите плейбуки для Ansible, которые будут автоматически настраивать HAProxy и Nginx на соответствующих серверах.
   - Используйте Ansible для распределения SSL-сертификатов на серверы и обновления конфигураций.

   Конечно, вот пример плейбуков Ansible для автоматической настройки HAProxy и Nginx, а также для распределения SSL-сертификатов на серверы и обновления конфигураций:

    4.1. **Плейбук для настройки HAProxy:**

    Создайте файл с именем `haproxy_setup.yml`:

    ```yaml
    ---
    - name: Configure HAProxy
    hosts: haproxy
    become: true
    tasks:
        - name: Install HAProxy
        apt:
            name: haproxy
            state: present

        - name: Copy HAProxy configuration
        template:
            src: haproxy.cfg.j2
            dest: /etc/haproxy/haproxy.cfg
        notify:
            - Restart HAProxy

    handlers:
        - name: Restart HAProxy
        service:
            name: haproxy
            state: restarted
    ```

    4.2. **Плейбук для настройки Nginx:**

    Создайте файл с именем `nginx_setup.yml`:

    ```yaml
    ---
    - name: Configure Nginx
    hosts: webservers
    become: true
    tasks:
        - name: Install Nginx
        apt:
            name: nginx
            state: present

        - name: Copy Nginx configuration
        template:
            src: nginx.conf.j2
            dest: /etc/nginx/sites-available/default
        notify:
            - Reload Nginx

    handlers:
        - name: Reload Nginx
        service:
            name: nginx
            state: reloaded
    ```

    4.3. **Плейбук для распределения SSL-сертификатов и обновления конфигураций:**

    Создайте файл с именем `ssl_config.yml`:

    ```yaml
    ---
    - name: Distribute SSL Certificates and Update Configurations
    hosts: all
    become: true
    tasks:
        - name: Copy SSL certificate files
        copy:
            src: /path/to/ssl_cert_files/
            dest: /etc/ssl/certs/
        notify:
            - Reload Services

    handlers:
        - name: Reload Services
        service:
            name: "{{ item }}"
            state: reloaded
        loop:
            - haproxy
            - nginx
    ```

    В этих плейбуках `haproxy` и `webservers` - это группы хостов, указанные в вашем файле инвентаря `inventory.ini`. Кроме того, вы должны создать файлы-шаблоны `haproxy.cfg.j2` и `nginx.conf.j2`, содержащие настройки HAProxy и Nginx соответственно.

    Пожалуйста, замените `/path/to/ssl_cert_files/` на фактический путь к вашим SSL-сертификатам. Эти плейбуки будут выполнять автоматическую настройку, обновление конфигураций и распределение сертификатов с использованием Ansible.

5. Тестирование:
   - Проведите тестирование, чтобы убедиться, что балансировка нагрузки работает корректно, запросы передаются от HAProxy к Nginx и веб-приложениям, и HTTPS соединение установлено правильно.

6. Масштабирование:
   - При необходимости добавьте дополнительные веб-серверы и настройте HAProxy для учета новых узлов.

7. Мониторинг и управление:
   - Добавьте инструменты мониторинга, такие как Grafana и Zabbix, для отслеживания производительности и доступности вашей инфраструктуры.

8. Автоматизация обслуживания:
   - Используйте Ansible для автоматического обновления пакетов и конфигураций на серверах.
